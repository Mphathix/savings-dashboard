<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Savings Dashboard ‚Äî Weekly R300 (Manager)</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.css" rel="stylesheet">

    <style>
        /* small custom styles */
        .week-cell {
            min-width: 84px;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 30;
            background: white;
        }

        /* subtle shadow for sticky */
        .sticky-col::after {
            content: "";
            position: absolute;
            right: -8px;
            top: 0;
            height: 100%;
            width: 8px;
            pointer-events: none;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(0, 0, 0, 0.03));
        }

        /* small mobile improvements */
        @media (max-width: 640px) {
            .week-cell {
                min-width: 68px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div class="max-w-7xl mx-auto px-4 py-8">

        <!-- Header -->
        <header class="flex items-start justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-semibold text-sky-700">Savings Dashboard</h1>
                <p class="text-sm text-slate-600 mt-1">Weekly contributions - manager dashboard. Members confirmed:
                    Mphathi, Smiso, Pocent, Fortune, Innocent, Steven, Mpho.</p>
            </div>

            <div class="space-y-2 text-right">
                <div class="bg-white p-3 rounded-lg shadow-sm flex gap-3 items-center">
                    <div class="text-xs text-slate-500">Weekly amount</div>
                    <input id="weeklyAmount" type="number" value="300" min="1"
                        class="w-24 px-2 py-1 border rounded-md text-right" />
                    <button id="saveAmountBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm">Save</button>
                </div>

                <div class="flex gap-2">
                    <button id="bulkPayBtn" class="px-3 py-2 bg-sky-500 text-white rounded-md shadow-sm text-sm">Bulk
                        Pay</button>
                    <button id="exportBtn"
                        class="px-3 py-2 border border-sky-500 text-sky-600 rounded-md text-sm">Export CSV</button>
                    <button id="resetBtn" class="px-3 py-2 bg-rose-500 text-white rounded-md text-sm">Reset All</button>
                </div>
            </div>
        </header>

        <!-- Summary cards -->

        <section class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">

            <!-- Total Saved -->
            <div class="bg-emerald-50 border border-emerald-200 p-4 rounded-lg shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-emerald-700 font-medium">Total Saved</div>
                        <div id="totalSaved" class="text-2xl font-bold text-emerald-900 mt-1">R0</div>
                    </div>
                    <div class="text-emerald-600 text-3xl">üí∞</div>
                </div>
            </div>

            <!-- Total Expected -->
            <div class="bg-sky-50 border border-sky-200 p-4 rounded-lg shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-sky-700 font-medium">Total Expected</div>
                        <div id="totalExpected" class="text-2xl font-bold text-sky-900 mt-1">R0</div>
                    </div>
                    <div class="text-sky-600 text-3xl">üìÖ</div>
                </div>
            </div>

            <!-- Payments Recorded -->
            <div class="bg-violet-50 border border-violet-200 p-4 rounded-lg shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-violet-700 font-medium">Payments Recorded</div>
                        <div id="weeksCompleted" class="text-2xl font-bold text-violet-900 mt-1">0</div>
                    </div>
                    <div class="text-violet-600 text-3xl">‚úîÔ∏è</div>
                </div>
            </div>

            <!-- REPLACEMENT for Available Balance -->
            <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg shadow-sm">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-amber-700 font-medium">Remaining Balance</div>
                        <div id="remainingExpected" class="text-2xl font-bold text-amber-900 mt-1">R0</div>
                    </div>
                    <div class="text-amber-600 text-3xl">üìâ</div>
                </div>
            </div>

        </section>


        <!-- Table -->
        <section class="bg-white rounded-lg shadow overflow-auto">
            <div class="min-w-max">
                <table class="table-auto w-full border-collapse">
                    <thead class="bg-sky-50">


                        <th class="p-3 sticky-col text-sm">Member</th>

                        <!-- <th class="p-3 text-sm">Total Paid</th> -->

                        <!-- Weeks header (will be injected) -->
                        <th id="weeksHeader" class="flex gap-2"></th>

                    </thead>

                    <tbody id="membersTbody" class="divide-y">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <p class="text-xs text-slate-500 mt-3">Tip: use <strong>Bulk Pay</strong> to mark multiple future weeks when
            someone pays in advance. Data is saved to your browser automatically.</p>
    </div>

    <!-- Bulk Pay Modal -->
    <div id="bulkModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
            <h3 class="text-lg font-semibold text-sky-700 mb-3">Bulk Payment (mark multiple weeks)</h3>

            <label class="block text-sm text-slate-600">Select Member</label>
            <select id="bulkMember" class="w-full p-2 border rounded mb-3"></select>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-sm text-slate-600">Start Week</label>
                    <input id="bulkStart" type="number" min="1" max="52" value="1" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm text-slate-600">Number of Weeks</label>
                    <input id="bulkCount" type="number" min="1" max="52" value="1" class="w-full p-2 border rounded">
                </div>
            </div>

            <div class="flex gap-2 justify-end">
                <button id="bulkCancel" class="px-3 py-2 border rounded">Cancel</button>
                <button id="bulkConfirm" class="px-3 py-2 bg-sky-600 text-white rounded">Apply</button>
            </div>
        </div>
    </div>

    <!-- small template for week header cell (hidden) -->
    <template id="weekHeaderTpl">
        <th class="p-2 week-cell text-xs text-slate-600"></th>
    </template>

    <script>
        // --- Configuration & Members ---
        const MEMBERS = ["Mphathi", "Smiso", "Pocent", "Fortune", "Innocent", "Steven", "Mpho"];
        const START_DATE = new Date(2025, 0, 3); // 3 Jan 2025 (month is 0-indexed)
        const WEEKS = 52;

        // Load weekly amount from localStorage or use default
        let weeklyAmount = Number(localStorage.getItem('weeklyAmount')) || 300;

        // Data structure: payments[member][weekIndex] = true/false
        let payments = JSON.parse(localStorage.getItem('payments_v1')) || {};

        // Ensure structure exists
        for (const m of MEMBERS) payments[m] = payments[m] || {};

        // Utility: format date to "dd MMM"
        function fmtDate(d) {
            return d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
        }

        // Generate Fridays list (52 weeks starting from START_DATE)
        function generateWeekDates() {
            const arr = [];
            for (let i = 0; i < WEEKS; i++) {
                const d = new Date(START_DATE);
                d.setDate(START_DATE.getDate() + i * 7);
                arr.push(new Date(d));
            }
            return arr;
        }

        const weekDates = generateWeekDates();

        // --- DOM caches ---
        const weeksHeader = document.getElementById('weeksHeader');
        const membersTbody = document.getElementById('membersTbody');
        const totalSavedEl = document.getElementById('totalSaved');
        const totalExpectedEl = document.getElementById('totalExpected');
        const weeksCompletedEl = document.getElementById('weeksCompleted');
        const availableBalanceEl = document.getElementById('availableBalance');
        const weeklyAmountInput = document.getElementById('weeklyAmount');
        const saveAmountBtn = document.getElementById('saveAmountBtn');
        const bulkPayBtn = document.getElementById('bulkPayBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Initialize UI
        weeklyAmountInput.value = weeklyAmount;

        // Render week headers
        function renderWeekHeaders() {
            // Clear existing (if any)
            weeksHeader.innerHTML = '';
            for (let i = 0; i < WEEKS; i++) {
                const th = document.createElement('th');
                th.className = 'p-2 week-cell text-xs text-slate-600';
                th.innerHTML = `<div class="text-[11px] font-medium">W${i + 1}</div><div class="text-[10px] text-slate-400">${fmtDate(weekDates[i])}</div>`;
                weeksHeader.parentElement.appendChild(th);
            }
        }

        // Render members rows
        function renderMembers() {
            membersTbody.innerHTML = '';
            for (const member of MEMBERS) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-sky-50';

                // Member column (sticky)
                const tdMember = document.createElement('td');
                tdMember.className = 'p-3 sticky-col';
                tdMember.innerHTML = `<div class="font-medium">${member}</div><div class="text-xs text-slate-500 mt-1">Member</div>`;
                tr.appendChild(tdMember);

                // Total paid
                const tdTotal = document.createElement('td');
                tdTotal.className = 'p-3 text-sm font-medium';
                tdTotal.id = `total-${member}`;
                tdTotal.textContent = 'R0';
                tr.appendChild(tdTotal);

                // Week cells
                for (let w = 0; w < WEEKS; w++) {
                    const td = document.createElement('td');
                    td.className = 'p-2 week-cell text-center';

                    const paid = payments[member] && payments[member][w] === true;
                    const btn = document.createElement('button');
                    btn.className = `w-full py-2 rounded ${paid ? 'bg-emerald-100 border border-emerald-300 text-emerald-700' : 'bg-slate-50 border border-slate-200 text-slate-500'}`;
                    btn.innerHTML = paid ? 'Paid' : '‚Äî';
                    btn.title = `${member} ‚Äî Week ${w + 1} ‚Äî ${fmtDate(weekDates[w])}`;

                    // toggle handler
                    btn.addEventListener('click', () => {
                        payments[member][w] = !payments[member][w];
                        if (!payments[member][w]) delete payments[member][w]; // keep object tidy
                        savePayments();
                        renderMembers(); // re-render to update colors & totals
                    });

                    td.appendChild(btn);
                    tr.appendChild(td);
                }

                membersTbody.appendChild(tr);
            }

            updateTotals();
        }

        // Calculate totals & update summary
        function updateTotals() {
            const amt = Number(localStorage.getItem('weeklyAmount')) || weeklyAmount;
            let totalSaved = 0;
            let weeksDoneSet = new Set();

            for (const m of MEMBERS) {
                const memberPaidWeeks = Object.keys(payments[m] || {}).filter(k => payments[m][k]).map(Number);
                const memberTotal = memberPaidWeeks.length * amt;
                totalSaved += memberTotal;
                // update per-member total cell
                const td = document.getElementById(`total-${m}`);
                if (td) td.textContent = `R${memberTotal.toLocaleString()}`;
                memberPaidWeeks.forEach(w => weeksDoneSet.add(w));
            }

            const totalExpected = amt * WEEKS * MEMBERS.length / MEMBERS.length * WEEKS / WEEKS; // simpler below
            const overallExpected = amt * WEEKS; // per person expected
            // But display total pool expected (for all members combined) OR show per-person - show both:
            const poolExpected = amt * WEEKS * MEMBERS.length;

            // weeks completed count (unique weeks that at least one person paid) OR total paid weeks per members? We'll show total weeks checked across all members
            let weeksCheckedCount = 0;
            for (const m of MEMBERS) {
                weeksCheckedCount += Object.keys(payments[m] || {}).filter(k => payments[m][k]).length;
            }

            totalSavedEl.textContent = `R${totalSaved.toLocaleString()}`;
            totalExpectedEl.textContent = `R${(overallExpected * MEMBERS.length).toLocaleString()} (pool)`;
            weeksCompletedEl.textContent = `${weeksCheckedCount} Payments`;
            const remaining = (overallExpected * MEMBERS.length) - totalSaved;
            document.getElementById("remainingExpected").textContent = `R${remaining.toLocaleString()}`;


            // (Optional) also paint header to show how many people have paid each week (small badge)
            paintWeekHeaderBadges();
        }

        // paint week header badges showing number of members paid that week
        function paintWeekHeaderBadges() {
            // find header cells (skip first two columns)
            const headerRow = weeksHeader.parentElement.parentElement.querySelector('thead tr');
            // remove existing painted cells beyond first two, then re-add (we appended earlier)
            // We'll instead loop through created ths starting at index 2
            const ths = headerRow.querySelectorAll('th');
            // first two ths are Member and Total Paid, rest are week headings we created earlier when renderWeekHeaders appended them
            // count payments per week
            for (let w = 0; w < WEEKS; w++) {
                const paidCount = MEMBERS.reduce((acc, m) => acc + (payments[m] && payments[m][w] ? 1 : 0), 0);
                const thIndex = 2 + w;
                const th = ths[thIndex];
                if (!th) continue;
                // clear existing small badge
                th.querySelectorAll('.badge-count').forEach(x => x.remove());
                if (paidCount > 0) {
                    const b = document.createElement('div');
                    b.className = 'badge-count text-[10px] bg-sky-600 text-white px-1 rounded mt-1 inline-block';
                    b.style.marginTop = '6px';
                    b.textContent = paidCount;
                    th.appendChild(b);
                }
            }
        }

        // Save payments to localStorage
        function savePayments() {
            localStorage.setItem('payments_v1', JSON.stringify(payments));
        }

        // Export CSV (simple)
        function exportCSV() {
            let csv = [];
            // header
            const header = ['Member', 'TotalPaid'];
            for (let w = 0; w < WEEKS; w++) header.push(`W${w + 1} (${fmtDate(weekDates[w])})`);
            csv.push(header.join(','));

            for (const m of MEMBERS) {
                const row = [];
                const paidWeeks = Object.keys(payments[m] || {}).filter(k => payments[m][k]).map(Number);
                const total = paidWeeks.length * (Number(localStorage.getItem('weeklyAmount')) || weeklyAmount);
                row.push(m);
                row.push(total);
                for (let w = 0; w < WEEKS; w++) row.push(payments[m] && payments[m][w] ? '1' : '0');
                csv.push(row.join(','));
            }

            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `savings_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Reset all
        function resetAll() {
            if (!confirm('Are you sure you want to reset ALL payments? This cannot be undone.')) return;
            payments = {};
            for (const m of MEMBERS) payments[m] = {};
            savePayments();
            renderMembers();
        }

        // Bulk Pay Modal logic
        const bulkModal = document.getElementById('bulkModal');
        const bulkMember = document.getElementById('bulkMember');
        const bulkStart = document.getElementById('bulkStart');
        const bulkCount = document.getElementById('bulkCount');
        const bulkCancel = document.getElementById('bulkCancel');
        const bulkConfirm = document.getElementById('bulkConfirm');

        function openBulkModal() {
            bulkMember.innerHTML = '';
            for (const m of MEMBERS) {
                const opt = document.createElement('option'); opt.value = m; opt.textContent = m;
                bulkMember.appendChild(opt);
            }
            bulkStart.value = 1; bulkCount.value = 1;
            bulkModal.classList.remove('hidden');
            bulkModal.classList.add('flex');
        }
        function closeBulkModal() {
            bulkModal.classList.add('hidden');
            bulkModal.classList.remove('flex');
        }

        bulkPayBtn.addEventListener('click', openBulkModal);
        bulkCancel.addEventListener('click', closeBulkModal);

        bulkConfirm.addEventListener('click', () => {
            const member = bulkMember.value;
            let start = parseInt(bulkStart.value, 10);
            let count = parseInt(bulkCount.value, 10);
            if (!member || isNaN(start) || isNaN(count) || start < 1 || start > WEEKS || count < 1) {
                alert('Please enter valid values (start between 1 and 52).');
                return;
            }
            if (start + count - 1 > WEEKS) {
                alert('Range exceeds 52 weeks.');
                return;
            }
            // mark weeks
            for (let i = start - 1; i < start - 1 + count; i++) payments[member][i] = true;
            savePayments();
            renderMembers();
            closeBulkModal();
        });

        // Event listeners
        exportBtn.addEventListener('click', exportCSV);
        resetBtn.addEventListener('click', resetAll);

        saveAmountBtn.addEventListener('click', () => {
            const val = Number(weeklyAmountInput.value) || 0;
            if (val <= 0) { alert('Enter a valid weekly amount'); return; }
            weeklyAmount = val;
            localStorage.setItem('weeklyAmount', weeklyAmount);
            renderMembers();
        });

        // Initial render
        renderWeekHeaders();
        renderMembers();

        // make sure payments structure persists even if new member added (not necessary here)
        window.addEventListener('beforeunload', savePayments);

    </script>
</body>

</html>
